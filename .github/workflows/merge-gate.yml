name: Merge Gate

# This workflow acts as a gatekeeper that blocks auto-merge until:
# 1. All CI checks (PR Validation) have passed
# 2. All three AI agents (Claude, Gemini, ChatGPT) have reviewed AND approved
#
# It runs after each review workflow completes and checks whether ALL required
# statuses are present and successful.

on:
  workflow_run:
    workflows:
      - "PR Validation"
      - "Claude Code Review"
      - "Gemini Code Assist"
      - "ChatGPT Codex Review"
    types: [completed]

permissions:
  statuses: write
  checks: read
  pull-requests: read

jobs:
  check-all-agent-signoffs:
    name: Verify All Agent Sign-offs
    runs-on: ubuntu-latest
    steps:
      - name: Get PR for this workflow run
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = context.payload.workflow_run.head_sha;
            const headBranch = context.payload.workflow_run.head_branch;

            if (!headSha) {
              console.log('No head SHA found');
              core.setOutput('has_pr', 'false');
              return;
            }

            // Find open PR for this branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${headBranch}`,
            });

            if (prs.length === 0) {
              console.log('No open PR found for this branch');
              core.setOutput('has_pr', 'false');
              return;
            }

            const pr = prs[0];
            console.log(`Found PR #${pr.number} (head SHA: ${pr.head.sha})`);
            core.setOutput('has_pr', 'true');
            core.setOutput('pr_number', pr.number);
            core.setOutput('head_sha', pr.head.sha);

      - name: Check all required statuses
        if: steps.get-pr.outputs.has_pr == 'true'
        id: check-statuses
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = '${{ steps.get-pr.outputs.head_sha }}';
            const prNumber = ${{ steps.get-pr.outputs.pr_number || 0 }};

            // These are the required agent sign-off status contexts
            const requiredStatuses = [
              'ai-review/claude',
              'ai-review/gemini',
              'ai-review/chatgpt',
            ];

            // Fetch all commit statuses for this SHA
            const { data: statusResponse } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha,
            });

            const statuses = statusResponse.statuses;
            console.log(`Found ${statuses.length} status(es) for SHA ${headSha}`);

            // Build a map of context -> latest state (statuses are returned newest first)
            const statusMap = {};
            for (const s of statuses) {
              // Only keep the latest status per context
              if (!statusMap[s.context]) {
                statusMap[s.context] = s;
              }
            }

            // Also check that all CI check runs have passed
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha,
            });

            const ciChecks = checkRuns.check_runs.filter(
              c => c.name !== 'Verify All Agent Sign-offs' &&
                   c.name !== 'Auto Merge After Checks Pass' &&
                   c.name !== 'Auto Delete Merged Branch'
            );

            // Report on CI checks
            let allCiPassed = true;
            let allCiCompleted = true;
            for (const check of ciChecks) {
              const status = check.status;
              const conclusion = check.conclusion;
              console.log(`CI Check: ${check.name} — status=${status}, conclusion=${conclusion}`);
              if (status !== 'completed') {
                allCiCompleted = false;
              } else if (conclusion !== 'success' && conclusion !== 'skipped') {
                allCiPassed = false;
              }
            }

            // Report on agent statuses
            let allAgentsApproved = true;
            let allAgentsPresent = true;
            const results = [];

            for (const ctx of requiredStatuses) {
              const s = statusMap[ctx];
              if (!s) {
                console.log(`MISSING: ${ctx} — no status found yet`);
                allAgentsPresent = false;
                allAgentsApproved = false;
                results.push({ context: ctx, state: 'missing', description: 'Review not submitted yet' });
              } else {
                console.log(`${ctx}: state=${s.state}, description=${s.description}`);
                results.push({ context: ctx, state: s.state, description: s.description });
                if (s.state !== 'success') {
                  allAgentsApproved = false;
                }
              }
            }

            // Determine overall gate status
            let gateState = 'failure';
            let gateDescription = '';

            if (!allCiCompleted) {
              gateDescription = 'Waiting for CI checks to complete';
            } else if (!allCiPassed) {
              gateDescription = 'CI checks have failed';
            } else if (!allAgentsPresent) {
              const missing = results.filter(r => r.state === 'missing').map(r => r.context);
              gateDescription = `Waiting for reviews: ${missing.join(', ')}`;
            } else if (!allAgentsApproved) {
              const notApproved = results.filter(r => r.state !== 'success').map(r => r.context);
              gateDescription = `Not approved by: ${notApproved.join(', ')}`;
            } else {
              gateState = 'success';
              gateDescription = 'All checks passed and all agents approved';
            }

            // Set the merge-gate commit status
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: headSha,
              state: gateState,
              description: gateDescription.substring(0, 140),
              context: 'merge-gate/all-agents-approved',
            });

            console.log(`\nMerge Gate: ${gateState} — ${gateDescription}`);

            if (gateState !== 'success') {
              core.setFailed(gateDescription);
            }
